<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>System Access â€” HyBox Admin</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    .admin-layout { max-width: 800px; margin: 60px auto; padding: 0 24px; }
    .auth-card { text-align: center; padding: 48px; }
    .hidden { display: none; }
    .dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px; }
    .status-badge { font-size: 12px; font-weight: 700; color: var(--accent); background: var(--bg); padding: 4px 12px; border-radius: 99px; }
    .form-section { margin-top: 32px; }
    .input-group { margin-bottom: 20px; text-align: left; }
    .input-group label { display: block; font-size: 13px; font-weight: 600; color: var(--muted); margin-bottom: 8px; }
    .checkbox-group { display: flex; align-items: center; gap: 10px; font-size: 14px; font-weight: 500; }
    .checkbox-group input { width: auto; }
  </style>
</head>
<body>

  <div class="admin-layout">
    <header class="dashboard-header">
      <div>
        <p class="status-badge">ADMIN_OS // ACCESS_CONTROL</p>
        <h1 class="section-title" style="margin-top: 8px;">System Access</h1>
      </div>
    </header>

    <!-- 1. AUTHENTICATION CARD -->
    <div id="auth-container" class="card auth-card">
      <div id="email-step">
        <div class="input-group">
          <label>Admin Identifier (Email)</label>
          <input type="email" id="admin-email" placeholder="enter admin email">
        </div>
        <button onclick="sendOTP()" class="btn-cta" style="width: 100%; margin-top: 12px;">Send Access Code</button>
      </div>

      <div id="otp-step" class="hidden">
        <div class="input-group">
          <label>Verification Code (OTP)</label>
          <input type="text" id="otp-code" placeholder="6-digit code">
        </div>
        <button onclick="verifyOTP()" class="btn-cta" style="width: 100%; margin-top: 12px;">Verify Identity</button>
      </div>
    </div>

    <!-- 2. MAIN DASHBOARD -->
    <div id="dashboard" class="hidden">
      <div class="card" style="margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center;">
        <div>
            <p style="font-size: 13px; color: var(--muted); font-weight: 600;">Active Session</p>
            <p id="user-email" style="font-weight: 700; color: var(--text);"></p>
        </div>
        <button onclick="signOut()" class="btn-cta" style="background: var(--bg); color: var(--text); border: 1px solid var(--border);">Sign Out</button>
      </div>

      <div class="card">
        <h2 class="section-title" style="font-size: 20px;">Add New Creation</h2>
        <form id="creation-form" class="form-section">
          <div class="input-group">
            <label>Creation Title</label>
            <input type="text" id="title" placeholder="e.g. Prompt Forge" required>
          </div>
          
          <div class="form-row">
            <div class="input-group">
              <label>Type</label>
              <select id="type" onchange="toggleApkLogic()">
                <option value="app">App</option>
                <option value="website">Website</option>
                <option value="book">Book</option>
              </select>
            </div>
            <div id="apk-logic" class="input-group checkbox-group" style="padding-top: 35px;">
              <input type="checkbox" id="is_apk">
              <label style="margin-bottom: 0;">Is APK File?</label>
            </div>
          </div>

          <div class="input-group">
            <label>Logo URL</label>
            <input type="text" id="logo_url" placeholder="https://..." required>
          </div>

          <div class="input-group">
            <label>Download / Redirect URL</label>
            <input type="text" id="download_url" placeholder="https://..." required>
          </div>

          <div class="input-group">
            <label>Short Description (Max 30 Words)</label>
            <textarea id="short_desc" maxlength="200" placeholder="Brief summary for the card..." required></textarea>
          </div>

          <div class="input-group">
            <label>Long Description (Detailed Breakdown)</label>
            <textarea id="long_desc" style="height: 250px;" placeholder="Full project details for the modal view..." required></textarea>
          </div>

          <button type="button" onclick="uploadCreation()" class="btn-cta" style="width: 100%;">Publish to Lab</button>
        </form>
      </div>
    </div>
  </div>

  <script>
    // Standalone initialization to avoid conflicts
    const SB_URL = 'https://buelbnurnlrisrokmxir.supabase.co';
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ1ZWxibnVybmxyaXNyb2tteGlyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzOTg4NTUsImV4cCI6MjA4NTk3NDg1NX0.WdXiIMmRJtFQPdWEp_oIg9-LV2KJdJWPO3V9KWZUXOk';
    const sb_admin = supabase.createClient(SB_URL, SB_KEY);

    async function sendOTP() {
      const email = document.getElementById('admin-email').value;
      if(!email) return alert("Email required.");
      const { error } = await sb_admin.auth.signInWithOtp({ email });
      if (error) alert(error.message);
      else {
        document.getElementById('email-step').classList.add('hidden');
        document.getElementById('otp-step').classList.remove('hidden');
      }
    }

    async function verifyOTP() {
      const email = document.getElementById('admin-email').value;
      const token = document.getElementById('otp-code').value;
      const { data, error } = await sb_admin.auth.verifyOtp({ email, token, type: 'signin' });
      
      if (error) {
        const signupRetry = await sb_admin.auth.verifyOtp({ email, token, type: 'signup' });
        if (signupRetry.error) alert(signupRetry.error.message);
        else checkSession();
      } else {
        checkSession();
      }
    }

    async function checkSession() {
      const { data: { session } } = await sb_admin.auth.getSession();
      if (session) {
        document.getElementById('auth-container').classList.add('hidden');
        document.getElementById('dashboard').classList.remove('hidden');
        document.getElementById('user-email').innerText = session.user.email;
      }
    }

    async function signOut() {
      await sb_admin.auth.signOut();
      location.reload();
    }

    function toggleApkLogic() {
      const type = document.getElementById('type').value;
      document.getElementById('apk-logic').style.visibility = type === 'app' ? 'visible' : 'hidden';
    }

    async function uploadCreation() {
      const btn = document.querySelector('#creation-form .btn-cta');
      const originalText = btn.innerText;
      btn.innerText = "Processing...";
      btn.disabled = true;

      const entry = {
        title: document.getElementById('title').value,
        short_desc: document.getElementById('short_desc').value,
        long_desc: document.getElementById('long_desc').value,
        type: document.getElementById('type').value,
        logo_url: document.getElementById('logo_url').value,
        download_url: document.getElementById('download_url').value,
        is_apk: document.getElementById('is_apk').checked
      };

      const { error } = await sb_admin.from('creations').insert([entry]);

      if (error) {
        alert("Database Error: " + error.message);
      } else {
        alert("Creation Added Successfully.");
        document.getElementById('creation-form').reset();
      }
      btn.innerText = originalText;
      btn.disabled = false;
    }

    window.onload = checkSession;
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- SEO: Service Agent Intent -->
    <title>Zavia â€” AI Liaison & Technical Support | HyBox</title>
    <meta name="description" content="Interact with Zavia, the HyBox Human Liaison. Get instant technical support, project inquiries, and studio information through our autonomous interface.">
    
    <!-- Assets -->
    <link rel="icon" type="image/svg+xml" href="/icon/favicon.svg">
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Archivo+Black&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    
    <!-- Chat Rendering Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>

    <!-- Schema: Service/Agent -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Service",
      "serviceType": "AI Liaison",
      "provider": {
        "@type": "Organization",
        "name": "HyBox"
      },
      "description": "Autonomous communication interface for project inquiries and studio support."
    }
    </script>
</head>
<body data-theme="light">
    <div class="app-layout">
        <header class="zavia-profile">
            <img src="img/1.webp" class="zavia-avatar-main" alt="Zavia">
            <div class="zavia-status-text">
                <h2>ZAVIA</h2>
                <p>Human Liaison // HyBox</p>
            </div>
            <button onclick="location.href='index.html'" class="exit-btn">EXIT</button>
        </header>

        <main id="chatbox">
            <div id="empty-state" style="margin: auto; text-align: center; opacity: 0.6;">
                <p style="font-family: 'Archivo Black'; font-size: 1.2rem;">How can I help you today?</p>
            </div>
        </main>

        <div id="writing-indicator" style="display: none; padding: 0 20px 10px; font-size: 0.7rem; font-weight: 800; color: var(--accent);">
            ZAVIA IS WRITING...
        </div>

        <div class="chat-input-box">
            <div class="input-group">
                <input type="text" id="messageInput" placeholder="Message Zavia..." autocomplete="off">
                <button id="sendButton">SEND</button>
            </div>
        </div>
    </div>

    <script>
        const chatbox = document.getElementById("chatbox");
        const messageInput = document.getElementById("messageInput");
        const sendButton = document.getElementById("sendButton");
        const writingIndicator = document.getElementById("writing-indicator");
        const chatId = crypto.randomUUID();

        let userAvatar = `https://api.dicebear.com/7.x/thumbs/svg?seed=${Math.random()}&backgroundColor=007AFF`;

        const systemPrompt = "You are Zavia, the Human Liaison for HyBox Labs. You are direct, professional, and technical. Use markdown for structure.";

        function appendMessage(content, role) {
            const emptyState = document.getElementById("empty-state");
            if (emptyState) emptyState.remove();
            
            const msgDiv = document.createElement("div");
            msgDiv.className = `msg ${role}`;
            const avatarSrc = role === 'ai' ? 'img/1.webp' : userAvatar;
            
            msgDiv.innerHTML = `
                <img src="${avatarSrc}" class="pfp">
                <div class="bubble">
                    <div class="text-content">${role === 'ai' ? marked.parse(content) : content}</div>
                </div>
            `;
            chatbox.appendChild(msgDiv);
            chatbox.scrollTop = chatbox.scrollHeight;
        }

        async function sendMessage() {
            const text = messageInput.value.trim();
            if (!text) return;

            appendMessage(text, 'user');
            messageInput.value = "";
            writingIndicator.style.display = "block";

            const websocket = new WebSocket("wss://backend.buildpicoapps.com/api/chatbot/chat");
            let fullText = "";
            let aiBubble = null;

            websocket.onopen = () => {
                websocket.send(JSON.stringify({
                    chatId: chatId,
                    appId: "per-free",
                    systemPrompt: systemPrompt,
                    message: text,
                }));
            };

            websocket.onmessage = (event) => {
                writingIndicator.style.display = "none";
                if (!aiBubble) {
                    aiBubble = document.createElement("div");
                    aiBubble.className = "msg ai";
                    aiBubble.innerHTML = `<img src="img/1.webp" class="pfp"><div class="bubble"><div class="text-content"></div></div>`;
                    chatbox.appendChild(aiBubble);
                }
                fullText += event.data;
                aiBubble.querySelector('.text-content').innerHTML = marked.parse(fullText);
                chatbox.scrollTop = chatbox.scrollHeight;
            };

            websocket.onclose = () => { writingIndicator.style.display = "none"; };
        }

        sendButton.onclick = sendMessage;
        messageInput.onkeydown = (e) => { if (e.key === "Enter") sendMessage(); };
    </script>
</body>
</html>